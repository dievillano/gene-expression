---
title: "Differential expression analysis"
format: pdf
editor: source
---

## Reading data 

```{r}
counts_raw <- readr::read_delim(
  "data/GSE292021_counts_quantseq_CryptoRNAseqFLC1.txt", delim = "\t",
  col_types = paste0(c("ciiici", rep("i", 30)), collapse = "")
)
colnames(counts_raw)[1:6] <- c(
  "gene", "chr", "start", "end", "strand", "length"
)
```

```{r}
samples_raw <- readr::read_delim(
  "data/GSE292021_CryptoRNAseqFLC1SampleKey_tabseparated.txt", delim = "\t",
  col_names = c(
    "sample", "temperature", "media", "bio_rep", "strain", "sample_name", 
    "flc1"
  ),
  col_select = -strain,
  col_types = "ccciccc", skip = 1
)
```

## Preprocessing

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
theme_set(theme_classic())
```

```{r}
samples <- samples_raw |> 
  mutate(
    temperature = factor(temperature, levels = c("37", "30")),
    media = factor(
      media, levels = unique(media), labels = c("Y", "YC", "YE", "YCE")
    ),
    strain = factor(flc1, levels = unique(flc1), labels = c("WT", "FL")),
    condition = sprintf("%s-%s-%s", strain, media, temperature),
    condition = factor(condition, levels = unique(condition))
  ) |> 
  select(-c(bio_rep, sample_name, flc1))
```

```{r}
counts <- counts_raw |> 
  select(c(names(counts_raw)[1:6], samples$sample))
```

```{r}
dim(counts)
```

```{r}
counts_long <- counts |> 
  pivot_longer(cols = S1:S30, names_to = "sample", values_to = "count") |> 
  left_join(samples, by = c("sample" = "sample")) |> 
  mutate(sample = factor(sample, levels = samples$sample))
```

```{r}
gene_summary <- counts_long |> 
  group_by(gene) |> 
  summarise(
    total = sum(count), mean = mean(count), var = var(count), sd = sd(count), 
    min = min(count), max = max(count), median = median(count), .groups = "drop"
  ) 

gene_summary |> 
  slice_head(n = 20)
```

```{r}
readr::write_csv(gene_summary, file = "results/gene_summary.csv")
```

```{r}
sample_summary <- counts_long |> 
  group_by(condition, sample) |> 
  summarise(total = sum(count), .groups = "drop")

sample_summary |> 
  slice_head(n = 20)
```

```{r}
readr::write_csv(sample_summary, file = "results/sample_summary.csv")
```

```{r}
libsizes_plot <- counts_long |> 
  group_by(condition, sample) |> 
  summarise(total_count = sum(count), .groups = "drop") |> 
  ggplot(aes(total_count/1.e6, sample, fill = condition)) +
  geom_bar(stat = "identity") +
  # scale_x_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) +
  labs(y = "Sample", x = "Library size (in millions)", fill = "Condition") +
  theme(axis.text = element_text(size = 7)) +
  ggsci::scale_fill_npg()

libsizes_plot
```

```{r}
ggsave("figures/lib_sizes.pdf", libsizes_plot, width = 7, height = 4.2)
```

```{r}
counts_mat <- counts |> 
  select(c(gene, S1:S30)) |> 
  tibble::column_to_rownames(var = "gene") |> 
  as.matrix()
```

----------------------------

```{r}
library(ComplexHeatmap)
```

```{r}
hm_metadata <- samples |> 
  tibble::column_to_rownames(var = "sample") |> 
  select(strain, media, temperature)
```

```{r}
counts_mat_top50var <- counts_mat[genes_top50var, ]
```

```{r}
count_hm_col <- circlize::colorRamp2(
  pretty(range(counts_mat_top50var/100), n = 3), 
  c('#ffffb2','#fecc5c','#fd8d3c','#f03b20','#bd0026')
)
```

```{r}
hm_annotation <-  HeatmapAnnotation(
  df = hm_metadata, simple_anno_size = unit(0.4, "cm"), 
  show_annotation_name = TRUE, col = conditions_pal,
  annotation_label = c("Strain", "Media", "Temperature"), 
  annotation_name_gp = gpar(fontsize = 7)
)
```

```{r}
counts_hm <- Heatmap(
  counts_mat_top50var/100, cluster_rows = TRUE, cluster_columns = TRUE, top_annotation = hm_annotation,
  col = count_hm_col, name = "Raw count\n(x100)", row_names_gp = gpar(fontsize = 7), column_names_gp = gpar(fontsize = 7),
  row_title = "Genes", row_title_gp = gpar(fontsize = 9), column_title = "Samples", column_title_gp = gpar(fontsize = 9)
)

draw(counts_hm)
```

```{r}
pdf(file = "figures/counts_hm.pdf", width = 6.5, height = 4)
draw(counts_hm)
dev.off()
```

-----------------------

### Pre-filtering

```{r}
library(edgeR)
```

```{r}
design <- model.matrix(
  ~ temperature + strain + media + temperature:strain + media:strain, 
  data = samples
)
```

```{r}
genes_keep <- filterByExpr(
  counts_mat, design = design, min.count = 10, min.total.count = 15
)
```

```{r}
saveRDS(genes_keep, file = "results/genes_keep.rds")
```

```{r}
counts_filter_mat <- counts_mat[genes_keep, ]
```

### Normalization and transformation

```{r}
counts_mats <- list(full = counts_mat, filter = counts_filter_mat)
```

```{r}
counts_mats_df <- tibble(type = c("full", "filter"), mat = counts_mats)
```

```{r}
transform_methods <- c("cpm", "logcpm", "rlog", "vst")
```

```{r}
library(tidyr)
```

```{r}
mats <- expand_grid(
  counts_mats_df, method = transform_methods
) |> 
  relocate(method, .before = mat)
```

```{r}
library(DESeq2)
```

```{r}
get_transform <- function(mat, method = "cpm", blind = TRUE) {
  if (!(method %in% c("cpm", "logcpm", "rlog", "vst"))) stop("Method not available.")
  
  if (method == "cpm") {
    mat_transform <- cpm(mat, normalized.lib.sizes = FALSE, log = FALSE)
  } else if (method == "logcpm" ) {
    mat_transform <- cpm(mat, normalized.lib.sizes = FALSE, log = TRUE)
  } else if (method == "rlog" ) {
    mat_transform <- rlog(mat, blind = blind)
  } else {
    mat_transform <- vst(mat, blind = blind)
  }
  
  mat_transform
}
```

```{r}
library(purrr)
```

```{r}
transformed <- mats |> 
  mutate(
    transformed = map2(
      mat, method, \(x, y) get_transform(x, y)
    )
  ) |> 
  select(-mat)
```

```{r}
transformed <- transformed |> 
  mutate(
    df = map(
      transformed,
      \(x) x |> 
        as.data.frame() |> 
        tibble::rownames_to_column("gene") |> 
        pivot_longer(
          cols = starts_with("S"), names_to = "sample", values_to = "expression"
        ) |> 
        inner_join(samples, by = c("sample" = "sample")) |> 
        mutate(sample = factor(sample, levels = samples$sample))
    )
  )
```

```{r}
transformed_filter <- transformed |> 
  filter(type == "filter") |> 
  select(method, df) |> 
  unnest(df) |> 
  mutate(
    method_factor = factor(method, labels = c("CPM*", "log2-CPM", "rlog", "VST"))
  )
```

```{r}
transformed_filter_boxplot <- transformed_filter |> 
  ggplot(aes(expression, y = sample, colour = condition)) +
  facet_wrap(vars(method_factor), ncol = 2, scales = "free_x") +
  geom_boxplot(outlier.size = 0.2, lwd = 0.5) +
  labs(x = "Expression level", y = "Sample", colour = "Condition") +
  theme(axis.text = element_text(size = 7)) +
  ggsci::scale_colour_npg()

transformed_filter_boxplot
```

```{r}
ggsave("figures/transformed_filter_boxplot.pdf", transformed_filter_boxplot, width = 9, height = 7)
```

```{r}
meansd_plot <- transformed_filter |> 
  group_by(method_factor, gene) |> 
  summarise(mean = mean(expression), sd = sd(expression)) |> 
  mutate(rank = rank(mean)) |> 
  ungroup() |> 
  ggplot(aes(rank, sd)) +
  facet_wrap(vars(method_factor), ncol = 2, scales = "free_y") +
  geom_point(colour = "grey", size = 0.2) +
  geom_smooth(
    method = "gam", formula = y ~ s(x, bs = "cs"), colour = "red", lwd = 0.5
  ) +
  labs(x = "Rank of mean expression level", y = "SD") +
  theme(axis.text = element_text(size = 7)) 

meansd_plot
```

```{r}
ggsave("figures/meansd_plot.pdf", meansd_plot, width = 6, height = 4)
```

### EDA

```{r}
# library(factoextra)
library(PCAtools)
```

```{r}
pca_results <- transformed |> 
  select(-df) |> 
  mutate(
    pca = map(
      transformed, 
      \(x) pca(
        x, metadata = tibble::column_to_rownames(samples, "sample"),
        removeVar = 0.9
      )
    ),
    n_comp = map(transformed, \(x) parallelPCA(x, max.rank = 10)$n),
    var_explained = map2(
      pca, n_comp, 
      \(x, y) cumsum(x$variance[seq_len(y)])[y]
    )
  )
```

```{r}
pca_results_comp <- pca_results |> 
  select(type, method, n_comp, var_explained) |> 
  unnest(c(n_comp, var_explained))

pca_results_comp
```

```{r}
readr::write_csv(pca_results_comp, "results/pca_results_comp.csv")
```

```{r}
pca_results_rlog <- filter(pca_results, type == "filter", method == "rlog")
pca_rlog <- pca_results_rlog$pca[[1]]
ncomp_rlog <- pca_results_rlog$n_comp[[1]]
```

```{r}
screeplot_rlog <- screeplot(
  pca_rlog, components = getComponents(pca_rlog, 1:10), vline = ncomp_rlog,
  title = NULL, axisLabSize = 5, colBar = "gray", sizeCumulativeSumLine = 0.5,
  sizeCumulativeSumPoints = 1
) +
  theme_classic() +
  theme(axis.text = element_text(size = 7))

screeplot_rlog
```

```{r}
ggsave("figures/screeplot_rlog.pdf", screeplot_rlog, width = 4, height = 3)
```

```{r}
pal <- ggsci::pal_bmj()(8)
```

```{r}
strain_cols <- pal[1:2]
names(strain_cols) <- levels(samples$strain)
media_cols <- pal[3:6]
names(media_cols) <- levels(samples$media)
temperature_cols <- rev(pal[7:8])
names(temperature_cols) <- levels(samples$temperature)
condition_cols <- ggsci::pal_npg()(10)
names(condition_cols) <- unique(samples$condition)
conditions_pal <- list(
  strain = strain_cols, media = media_cols, temperature = temperature_cols,
  condition = condition_cols
)
```

```{r}
plot_pca_rotations <- function(pca_results, metadata, colour_by, shape_by = NULL, pc_x = 1, pc_y = 2, point_size = 2) {

  rotations <- as.data.frame(pca_results$rotated)
  variance <- pca_results$variance
  
  pcx <- paste0("PC", pc_x)
  pcy <- paste0("PC", pc_y)
  comp_var <- format(variance[c(pc_x, pc_y)], digits = 2, nsmall = 2)

  rotated_meta <- rotations |>
    tibble::rownames_to_column(var = "sample") |>
    left_join(metadata, by = "sample")

  x_max <- max(abs(rotated_meta[[pcx]])) * 1.05
  y_max <- max(abs(rotated_meta[[pcy]])) * 1.05
  
  p <- ggplot(rotated_meta, aes(x = !!sym(pcx), y = !!sym(pcy))) +
    geom_hline(yintercept = 0, linetype = "dashed") +
    geom_vline(xintercept = 0, linetype = "dashed") 
  
  if (is.null(shape_by)) {
    p <- p + 
      geom_point(aes(colour = !!sym(colour_by)), size = point_size)
  } else {
    p <- p + 
      geom_point(
        aes(colour = !!sym(colour_by), shape = !!sym(shape_by)), 
        size = point_size
      )
  }
  
  p +
    scale_x_continuous(limits = c(-x_max, x_max)) +
    scale_y_continuous(limits = c(-y_max, y_max)) +
    labs(
      x = glue::glue("{pcx} ({comp_var[1]}%)"),
      y = glue::glue("{pcy} ({comp_var[2]}%)"),
      colour = colour_by,
      shape = if (!is.null(shape_by)) shape_by else NULL
    ) 
}
```

```{r}
pca_rlog <- pca_results |> 
  filter(type == "filter", method == "rlog") |> 
  pull(pca) |> 
  magrittr::extract2(1) 
```

```{r}
pca12_rlog_plot <- plot_pca_rotations(
  pca_rlog, metadata = samples, colour_by = "condition"
) +
  scale_color_discrete(name = "Condition", type = conditions_pal$condition) 

pca12_rlog_plot
```

```{r}
pca13_rlog_plot <- plot_pca_rotations(
  pca_rlog, metadata = samples, pc_y = 3, colour_by = "condition"
) +
  scale_color_discrete(name = "Condition", type = conditions_pal$condition) 

pca13_rlog_plot
```

```{r}
pca23_rlog_plot <- plot_pca_rotations(
  pca_rlog, metadata = samples, pc_x = 2, pc_y = 3, colour_by = "condition"
) +
  scale_color_discrete(name = "Condition", type = conditions_pal$condition) 

pca23_rlog_plot
```

```{r}
library(patchwork)
```

```{r}
pca_rlog_plot <- pca12_rlog_plot + pca13_rlog_plot + pca23_rlog_plot + 
  plot_layout(ncol = 2, guides = "collect") +
  plot_annotation(tag_levels = 'A')

pca_rlog_plot
```


```{r}
ggsave("figures/pca_rlog_plot.pdf", pca_rlog_plot, width = 12, height = 8)
```


```{r}
pca12_rlog_fact_plot <- plot_pca_rotations(
  pca_rlog, metadata = samples, colour_by = "strain", 
  shape_by = "media"
) +
  scale_color_discrete(name = "Strain", type = conditions_pal$strain) +
  scale_shape_discrete(name = "Media") +
  theme(legend.position = "top")

pca12_rlog_fact_plot
```

```{r}
pca13_rlog_fact_plot <- plot_pca_rotations(
  pca_rlog, metadata = samples, colour_by = "temperature", 
  shape_by = "strain", pc_x = 1, pc_y = 3
) +
  scale_color_discrete(name = "Temperature", type = conditions_pal$temperature) +
  scale_shape_discrete(name = "Strain") +
  theme(legend.position = "top")

pca13_rlog_fact_plot
```

```{r}
pca23_rlog_fact_plot <- plot_pca_rotations(
  pca_rlog, metadata = samples, colour_by = "media", 
  shape_by = "temperature", pc_x = 2, pc_y = 3
) +
  scale_color_discrete(name = "Media", type = conditions_pal$media) +
  scale_shape_discrete(name = "Temperature") +
  theme(legend.position = "top")

pca23_rlog_fact_plot
```

```{r}
plot_pca_loadings <- function(pca_results, pc_x = 1, pc_y = 2, top_n = 5) {
  loadings <- pca_results$loadings
  variance <- pca_results$variance
  
  pcx_col <- paste0("PC", pc_x)
  pcy_col <- paste0("PC", pc_y)
  
  comp_var <- format(variance[c(pc_x, pc_y)], digits = 2, nsmall = 2)
  
  loadings_tbl <- loadings |>
    tibble::rownames_to_column(var = "gene") |>
    as_tibble()
  
  top_x <- loadings_tbl |>
    slice_max(order_by = abs(!!sym(pcx_col)), n = top_n)

  top_y <- loadings_tbl |>
    slice_max(order_by = abs(!!sym(pcy_col)), n = top_n)
  
  top_genes <- bind_rows(top_x, top_y) |>
    distinct(gene, .keep_all = TRUE)
  
  x_max <- max(abs(top_genes[[pcx_col]])) * 1.05
  y_max <- max(abs(top_genes[[pcy_col]])) * 1.05

  ggplot(top_genes, aes(x = !!sym(pcx_col), y = !!sym(pcy_col))) +
    geom_segment(
      aes(x = 0, y = 0, xend = !!sym(pcx_col), yend = !!sym(pcy_col)),
      arrow = arrow(length = unit(0.2, "cm")),
      color = "gray", alpha = 0.6
    ) +
    geom_text_repel(aes(label = gene), size = 3.5, max.overlaps = Inf) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_hline(yintercept = 0, linetype = "dashed") +
    scale_x_continuous(limits = c(-x_max, x_max)) +
    scale_y_continuous(limits = c(-y_max, y_max)) +
    labs(
      x = glue::glue("PC{pc_x} ({comp_var[1]}%)"),
      y = glue::glue("PC{pc_y} ({comp_var[2]}%)")
    ) 
}
```

```{r}
pca12_rlog_load_plot <- plot_pca_loadings(
  pca_rlog, pc_x = 1, pc_y = 2, top_n = 5
)

pca12_rlog_load_plot
```

```{r}
pca13_rlog_load_plot <- plot_pca_loadings(
  pca_rlog, pc_x = 1, pc_y = 3, top_n = 5
)

pca13_rlog_load_plot
```

```{r}
pca23_rlog_load_plot <- plot_pca_loadings(
  pca_rlog, pc_x = 2, pc_y = 3, top_n = 5
)

pca23_rlog_load_plot
```

```{r}
pca_rlog_full_plot <- 
  ((pca12_rlog_fact_plot + pca12_rlog_load_plot) + plot_layout(tag_level = "new")) /
  ((pca13_rlog_fact_plot + pca13_rlog_load_plot) + plot_layout(tag_level = "new")) /
  ((pca23_rlog_fact_plot + pca23_rlog_load_plot) + plot_layout(tag_level = "new")) +
  plot_annotation(tag_levels = c("A", "1"))

pca_rlog_full_plot
```

```{r}
ggsave("figures/pca_rlog_full_plot.pdf", pca_rlog_full_plot, width = 12, height = 12)
```







```{r}
pca_plots <- pca_results |> 
  mutate(
    pca_plot_12 = pmap(
      list(a = type, b = method, c = pca), 
      \(a, b, c) {
        biplot(
          c, x = "PC1", y = "PC2", showLoadings = TRUE, colby = "strain", 
          shape = "media", hline = 0, vline = 0, legendPosition = "right", 
          ntopLoadings = 10, max.overlaps = 50, lengthLoadingsArrowsFactor = 3,
          xlim = c(-100, 100), ylim = c(-50, 50)
        ) +
          ggtitle(paste0(b, " transformation - ", a))
      }
    ),
    pca_plot_13 = pmap(
      list(a = type, b = method, c = pca), 
      \(a, b, c) {
        biplot(
          c, x = "PC1", y = "PC3", showLoadings = TRUE, colby = "strain",
          shape = "temperature", hline = 0, vline = 0, legendPosition = "right", 
          ntopLoadings = 10, max.overlaps = 50, lengthLoadingsArrowsFactor = 3
        ) +
          ggtitle(paste0(b, " transformation - ", a))
      }
    ),
    pca_plot_23 = pmap(
      list(a = type, b = method, c = pca), 
      \(a, b, c) {
        biplot(
          c, x = "PC2", y = "PC3", showLoadings = TRUE, colby = "media",
          shape = "temperature", hline = 0, vline = 0, legendPosition = "right", 
          ntopLoadings = 10, max.overlaps = 50, lengthLoadingsArrowsFactor = 3
        ) +
          ggtitle(paste0(b, " transformation - ", a))
      }
    )
  )
```

```{r}
for (plt in pca_results$pca_plot_12) print(plt)
```

```{r}
for (plt in pca_results$pca_plot_13) print(plt)
```

```{r}
for (plt in pca_results$pca_plot_23) print(plt)
```

```{r}
pca_results <- pca_results |> 
  mutate(
    loadings_plot = pmap(
      list(a = type, b = method, c = pca), 
      \(a, b, c) {
        plotloadings(
          c, components = getComponents(c, 1:3), rangeRetain = 0.01) +
          ggtitle(paste0(b, " transformation - ", a)
        )
      }
    ),
    loadings = map(
      pca, \(x) getLoadings(x, components = getComponents(x, 1:3))
    )
  )
```

```{r}
for (plt in pca_results$loadings_plot) print(plt)
```

```{r}
pca_boxplot <- function(pca, cond, type, method) {
  pca$rotated |> 
    tibble::rownames_to_column(var = "sample") |> 
    select(c(sample, PC1:PC3)) |> 
    inner_join(samples, by = c("sample" = "sample")) |> 
    pivot_longer(cols = PC1:PC3) |> 
    ggplot(aes({{cond}}, value)) +
    geom_boxplot() +
    facet_wrap(vars(name), ncol = 3) +
    ggtitle(paste0(method, " transformation - ", type))
}
```


```{r}
pca_results <- pca_results |> 
  mutate(
    boxplot_strain = pmap(
      list(a = type, b = method, c = pca), 
      \(a, b, c) pca_boxplot(c, strain, a, b)
    ),
    boxplot_media = pmap(
      list(a = type, b = method, c = pca), 
      \(a, b, c) pca_boxplot(c, media, a, b)
    ),
    boxplot_temperature = pmap(
      list(a = type, b = method, c = pca), 
      \(a, b, c) pca_boxplot(c, temperature, a, b)
    )
  )
```

```{r}
for (plt in pca_results$boxplot_strain) print(plt)
```

```{r}
for (plt in pca_results$boxplot_media) print(plt)
```

```{r}
for (plt in pca_results$boxplot_temperature) print(plt)
```

### Differential expression analysis

```{r}
de_dfs <- counts_mats_df |> 
  mutate(
    de_df = map(
      mat,
      \(x) DESeqDataSetFromMatrix(
        countData = x, colData = samples, 
        design = ~ strain + media + temperature + strain:media + 
          strain:temperature
      )
    ),
    de = map(de_df, DESeq)
  )
```

```{r}
plotDispEsts(de_dfs$de[[1]])
plotDispEsts(de_dfs$de[[2]])
```

```{r}
res_names <- resultsNames(de_dfs$de[[1]])[-1]
```

```{r}
de_contrasts <- tibble::tibble(term = res_names) |> 
  mutate(
    contrast = purrr::map(
      term,
      \(x) c(0, as.numeric(res_names == x))
    )
  )
```

```{r}
de <- tidyr::expand_grid(de_dfs, de_contrasts) |> 
  relocate(term, .before = mat)
```

```{r}
de_results <- de |> 
  mutate(
    result = map2(
      de, term,
      \(x, y) results(
        x, name = y, lfcThreshold = 0, alpha = 0.1, 
        independentFiltering = TRUE
      )
    ),
    result_df = purrr::map(
      result,
      \(x) as.data.frame(x) |> 
        tibble::rownames_to_column(var = "gene") |> 
        relocate(gene, .before = everything()) |> 
        mutate(
          detection_call = case_when(
            padj < 0.1 ~ 1,
            padj >= 0.1 ~ 0,
            is.na(padj) ~ NA_integer_
          )
        )
    )
  )
```

```{r}
removed_by_filter <- de_results |> 
  mutate(
    removed_genes = map(
      result_df, 
      \(x) x |> filter(is.na(padj)) |> pull(gene) 
    )
  ) |> 
  select(type, term, removed_genes) |> 
  pivot_wider(
    id_cols = term, names_from = type, values_from = removed_genes
  ) 

removed_by_filter
```


```{r}
de_results <- de_results |> 
  mutate(
    top_labels = map(
      result_df,
      \(x) x |> 
        drop_na(padj) |> 
        arrange(padj) |> 
        slice_head(n = 10) |> 
        pull(gene)
    ),
    ma_plot = pmap(
      list(a = type, b = term, c = result, d = top_labels),
      \(a, b, c, d) {
        ggpubr::ggmaplot(
          c, fdr = 0.1, fc = 1, size = 0.5, main = paste0(b, " - ", a),
          top = 0, label.select = d
        )
      }
    ),
    volcano_plot = pmap(
      list(a = type, b = term, c = result_df, d = top_labels),
      \(a, b, c, d) {
        EnhancedVolcano::EnhancedVolcano(
          c, lab = c$gene, x = "log2FoldChange", y = "padj", 
          title = paste0(b, " - ", a), subtitle = NULL, caption = NULL, 
          pCutoff = 0.1, FCcutoff = 0, pointSize = 0.5, selectLab = d,
          drawConnectors = TRUE, arrowheads = FALSE
        )
      } 
    ),
    pvalue_plot = pmap(
      list(a = type, b = term, c = result_df, d = result),
      \(a, b, c, d) {
        c |>
          filter(baseMean > metadata(d)$filterThreshold) |>
          ggplot(aes(pvalue)) +
          geom_histogram(breaks = 0:20/20) +
          ggtitle(paste0(b, " - ", a))
      }
    )
  )
```

```{r}
inter_terms <- c(
  "straindelta.mediaYPD_CFW", "straindelta.mediaYPD_EGTA",
  "straindelta.mediaYPD_CFW_EGTA", "straindelta.temperature30"
)

de_results_inter <- de_results |> 
  filter(type == "filter", term %in% inter_terms)
```

```{r}
for (plt in de_results_inter$ma_plot) print(plt)
```
```{r}
for (plt in de_results_inter$volcano_plot) print(plt)
```


```{r}
for (plt in de_results_inter$pvalue_plot) print(plt)
```

```{r}
detected <- de_results |> 
  mutate(
    detected_genes = purrr::map(
      result_df, 
      \(x) x |> 
        filter(detection_call == 1) |> 
        pull(gene)
    )
  ) |> 
  select(type, term, detected_genes) |> 
  pivot_wider(
    id_cols = term, names_from = type, values_from = detected_genes
  ) 
```



```{r}
detected <- detected |> 
  mutate(
    comb_mat = map2(
      full, filter, 
      \(x, y) {
        l <- list(full = x, filter = y)
        make_comb_mat(l)
      }
    ),
    upset_plot = map(
      comb_mat, 
      \(x) UpSet(
        x, comb_order = order(comb_size(x), decreasing = TRUE), 
        top_annotation = upset_top_annotation(x, add_numbers = TRUE),
        right_annotation = upset_right_annotation(x, add_numbers = TRUE)
      )
    )
  )
```

```{r}
for (plt in detected$upset_plot[4:6]) print(plt)
```

```{r}
detected_inter <- detected |> 
  filter(term %in% inter_terms) |> 
  select(c(term, filter))

detected_inter_list <- detected_inter$filter
names(detected_inter_list) <- detected_inter$term
```

```{r}
comb_mat_inter <- make_comb_mat(detected_inter_list)
```

```{r}
UpSet(
  comb_mat_inter, 
  comb_order = order(comb_size(comb_mat_inter), decreasing = TRUE), 
  top_annotation = upset_top_annotation(comb_mat_inter, add_numbers = TRUE),
  right_annotation = upset_right_annotation(comb_mat_inter, add_numbers = TRUE)
)
```

Explore genes not found by filtering.

```{r}
detected_genes <- de_results_inter |> 
  select(result_df) |> 
  unnest(result_df) |> 
  filter(detection_call == 1) |> 
  pull(gene) |> 
  unique()

length(detected_genes)
```

```{r}
clustering <- transformed |> 
  filter(type == "filter") |> 
  select(method, mat) |> 
  mutate(
    transformed = map2(
      method, mat, \(x, y) get_transform(y, method = x, blind = FALSE)
    )
  )
```

```{r}
samples_heatmap <- samples |> 
  tibble::column_to_rownames(var = "sample") |> 
  select(strain, media, temperature)
```



```{r}
ha <-  HeatmapAnnotation(
  df = samples_heatmap[, rev(colnames(samples_heatmap))], 
  simple_anno_size = unit(0.4, "cm"), show_annotation_name = TRUE, 
  col = conditions_pal
)
```

```{r}
clustering <- clustering |> 
  mutate(
    transformed = map(transformed, \(x) x[detected_genes,]),
    genes_vars = map(transformed, \(x) rowVars(x)),
    genes_keep = map(
      genes_vars, \(x) order(x, decreasing = TRUE)[1:300]
    ),
    transformed_keep = map2(transformed, genes_keep, \(x, y) x[y, ]),
    transformed_keep_scale = map(transformed_keep, \(x) t(scale(t(x)))),
    heatmap = map2(
      method, transformed_keep_scale,
      \(x, y) {
        set.seed(123)
        h <- Heatmap(
          y, show_row_names = FALSE, clustering_method_rows = "ward.D2",
          clustering_method_columns = "ward.D2", km = 4, row_km_repeats = 5,
          clustering_distance_rows = "pearson", top_annotation = ha,
          col = col_fun
        ) 
        draw(h)
      }
    )
  )
```

```{r}
for (plt in clustering$heatmap) print(plt)
```

```{r}
clustering <- clustering |> 
  mutate(
    clust_list = map2(
      transformed_keep_scale, heatmap, 
      \(x, y) lapply(row_order(y), \(a) row.names(x)[a])
    ),
    clust_df = map(
      clust_list, 
      \(x) list_rbind(
        imap(x, \(y, idy) tibble(gene = y, cluster = idy))
      )
    ),
    gene_clust = map2(
      transformed_keep_scale, clust_df,
      \(x, y) x |> 
        as.data.frame() |> 
        tibble::rownames_to_column(var = "gene") |> 
        pivot_longer(
          starts_with("S"), names_to = "sample", values_to = "expression"
        ) |> 
        inner_join(samples, by = c("sample" = "sample")) |> 
        inner_join(y, by = "gene")
    ),
    lineplot_temperature = map2(
      method, gene_clust, 
      \(x, y) y |> 
        group_by(cluster, strain, temperature) |> 
        summarise(mean = mean(expression), sd = sd(expression), .groups = "drop") |> 
        ggplot(aes(forcats::fct_rev(temperature), mean, colour = cluster, group = cluster)) +
        geom_point() +
        geom_line() +
        facet_wrap(vars(strain)) +
        ggtitle(x)
    ),
    lineplot_media = map2(
      method, gene_clust, 
      \(x, y) y |> 
        group_by(cluster, strain, media) |> 
        summarise(mean = mean(expression), sd = sd(expression), .groups = "drop") |> 
        ggplot(aes(media, mean, colour = cluster, group = cluster)) +
        geom_point() +
        geom_line() +
        facet_wrap(vars(strain)) +
        ggtitle(x)
    )
  )
```

```{r}
for (plt in clustering$lineplot_temperature) print(plt)
```

```{r}
for (plt in clustering$lineplot_media) print(plt)
```

```{r}
de_results_inter_df <- de_results_inter |> 
  select(term, result_df) |> 
  unnest(result_df)
```

```{r}
readr::write_csv(de_results_inter_df, "de_results_inter.csv", na = "")
```





